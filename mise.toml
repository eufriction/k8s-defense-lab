[tools]
hk = "latest"
pkl = "latest"
k9s = "latest"
kind = "latest"
helm = "latest"
cilium-cli = "latest"
cilium-hubble = "latest"
kyverno = "latest"
node = "latest"
prettier = "latest"
vale = "latest"

[hooks]
enter = "hk install"

[tasks.lint]
description = "Run all pre-commit checks against all files"
run = "hk run pre-commit --all"

[env]
NETSHOOT_VERSION = "v0.15"
HTTPBIN_VERSION = "2.20.0"
CILIUM_VERSION = "1.19.1"
HUBBLE_UI_VERSION = "0.13.3"
CILIUM_ENVOY_VERSION = "1.35.9-1770979049-232ed4a26881e4ab4f766f251f258ed424fff663"
KYVERNO_CHART_VERSION = "3.7.0"
KYVERNO_APP_VERSION = "1.17.0"
KIND_CLUSTER_NAME = "k8s-defense-lab"

[tasks."kind:start"]
description = "Create the k8s-defense-lab kind cluster using config/kind.config"
run = "kind create cluster --config config/kind.config"

[tasks."kind:stop"]
description = "Delete the k8s-defense-lab kind cluster"
run = "kind delete cluster --name $KIND_CLUSTER_NAME"

[tasks."kind:restart"]
description = "Delete and recreate the k8s-defense-lab kind cluster"
depends = ["kind:stop"]
run = "mise run kind:start"

[tasks."helm:repo:add"]
description = "Add the Cilium and Kyverno Helm repos"
run = [
  "helm repo add cilium https://helm.cilium.io/",
  "helm repo add kyverno https://kyverno.github.io/kyverno/",
  "helm repo update"
]

[tasks."cilium:pull"]
description = "Pull Cilium images from the registry to the local Docker daemon"
run = [
  "docker pull quay.io/cilium/cilium:v$CILIUM_VERSION",
  "docker pull quay.io/cilium/operator-generic:v$CILIUM_VERSION",
  "docker pull quay.io/cilium/hubble-relay:v$CILIUM_VERSION",
  "docker pull quay.io/cilium/hubble-ui:v$HUBBLE_UI_VERSION",
  "docker pull quay.io/cilium/hubble-ui-backend:v$HUBBLE_UI_VERSION",
  "docker pull quay.io/cilium/cilium-envoy:v$CILIUM_ENVOY_VERSION",
]

[tasks."cilium:load"]
description = "Load Cilium images from the local Docker daemon into the kind cluster nodes"
depends = ["cilium:pull"]
run = [
  "kind load docker-image quay.io/cilium/cilium:v$CILIUM_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image quay.io/cilium/operator-generic:v$CILIUM_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image quay.io/cilium/hubble-relay:v$CILIUM_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image quay.io/cilium/hubble-ui:v$HUBBLE_UI_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image quay.io/cilium/hubble-ui-backend:v$HUBBLE_UI_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image quay.io/cilium/cilium-envoy:v$CILIUM_ENVOY_VERSION --name $KIND_CLUSTER_NAME",
]

[tasks."kyverno:pull"]
description = "Pull Kyverno images from the registry to the local Docker daemon"
run = [
  "docker pull ghcr.io/kyverno/kyverno:v$KYVERNO_APP_VERSION",
  "docker pull ghcr.io/kyverno/background-controller:v$KYVERNO_APP_VERSION",
  "docker pull ghcr.io/kyverno/cleanup-controller:v$KYVERNO_APP_VERSION",
  "docker pull ghcr.io/kyverno/reports-controller:v$KYVERNO_APP_VERSION",
]

[tasks."kyverno:load"]
description = "Load Kyverno images from the local Docker daemon into the kind cluster nodes"
depends = ["kyverno:pull"]
run = [
  "kind load docker-image ghcr.io/kyverno/kyverno:v$KYVERNO_APP_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image ghcr.io/kyverno/background-controller:v$KYVERNO_APP_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image ghcr.io/kyverno/cleanup-controller:v$KYVERNO_APP_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image ghcr.io/kyverno/reports-controller:v$KYVERNO_APP_VERSION --name $KIND_CLUSTER_NAME",
]

[tasks."apps:pull"]
description = "Pull demo app images from the registry to the local Docker daemon"
run = [
  "docker pull nicolaka/netshoot:$NETSHOOT_VERSION",
  "docker pull mccutchen/go-httpbin:$HTTPBIN_VERSION",
]

[tasks."apps:load"]
description = "Load demo app images from the local Docker daemon into the kind cluster nodes"
depends = ["apps:pull"]
run = [
  "kind load docker-image nicolaka/netshoot:$NETSHOOT_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image mccutchen/go-httpbin:$HTTPBIN_VERSION --name $KIND_CLUSTER_NAME",
]

[tasks."cilium:uninstall"]
description = "Uninstall Cilium from the cluster using Helm"
run = "helm uninstall cilium --namespace kube-system"

[tasks."kyverno:uninstall"]
description = "Uninstall Kyverno from the cluster using Helm"
run = "helm uninstall kyverno --namespace kyverno"

[tasks."cilium:install"]
description = "Install Cilium in kube-proxy-free mode using Helm"
depends = ["helm:repo:add", "cilium:load"]
run = """
APISERVER_IP=$(docker inspect -f '{% raw %}{{.NetworkSettings.Networks.kind.IPAddress}}{% endraw %}' ${KIND_CLUSTER_NAME}-control-plane)
if [ -z "$APISERVER_IP" ]; then
  echo "ERROR: could not resolve control-plane IP from Docker â€“ is the kind cluster running?" >&2
  exit 1
fi
helm install cilium cilium/cilium \
  --namespace kube-system \
  --version $CILIUM_VERSION \
  --values config/values.cilium.yaml \
  --set k8sServiceHost=$APISERVER_IP \
  --set k8sServicePort=6443
"""
run_windows = """
$APISERVER_IP = docker inspect -f '{% raw %}{{.NetworkSettings.Networks.kind.IPAddress}}{% endraw %}' "${env:KIND_CLUSTER_NAME}-control-plane"
if (-not $APISERVER_IP) {
  Write-Error "ERROR: could not resolve control-plane IP from Docker - is the kind cluster running?"
  exit 1
}
helm install cilium cilium/cilium `
  --namespace kube-system `
  --version $env:CILIUM_VERSION `
  --values config/values.cilium.yaml `
  --set k8sServiceHost=$APISERVER_IP `
  --set k8sServicePort=6443
"""

[tasks."apps:start"]
description = "Create frontend and backend namespaces with netshoot pods as the attack platform for the demo"
depends = ["apps:load"]
run = "kubectl apply -k apps/"

[tasks."apps:stop"]
description = "Delete the frontend and backend demo namespaces and all their resources"
run = "kubectl delete -k apps/ --ignore-not-found"

[tasks."apps:restart"]
description = "Tear down and recreate the demo environment"
depends = ["apps:stop"]
run = "mise run apps:start"

[tasks."apps:verify"]
description = "Verify the demo apps are healthy"
depends_post = ["apps:start"]
run = [
  "kubectl wait pod/web -n frontend --for=condition=Ready --timeout=60s",
  "kubectl wait pod/api -n backend --for=condition=Ready --timeout=60s"
]

[tasks."cluster:start"]
description = "Bootstrap the full cluster: kind + Cilium + Kyverno in order"
depends = ["kind:start"]
run = "mise run cilium:install && cilium status --wait && mise run kyverno:install"
run_windows = "mise run cilium:install && cilium status --wait && mise run kyverno:install"

[tasks."cluster:verify"]
description = "Verify the cluster is healthy: Cilium status and Kyverno pods ready"
depends_post = ["cluster:start"]
run = [
  "cilium status --wait",
  "kubectl wait pods --all -n kyverno --for=condition=Ready --timeout=120s"
]

[tasks."cluster:stop"]
description = "Delete the full cluster"
run = "mise run kind:stop"

[tasks."cluster:restart"]
description = "Delete and fully rebuild the cluster"
depends = ["cluster:stop"]
run = "mise run cluster:start"

[tasks."kyverno:install"]
description = "Install Kyverno using Helm"
depends = ["helm:repo:add", "kyverno:load"]
run = """
helm install kyverno kyverno/kyverno \
  --namespace kyverno \
  --create-namespace \
  --version $KYVERNO_CHART_VERSION \
  --values config/values.kyverno.yaml
"""
run_windows = """
helm install kyverno kyverno/kyverno `
  --namespace kyverno `
  --create-namespace `
  --version $env:KYVERNO_CHART_VERSION `
  --values config/values.kyverno.yaml
"""
