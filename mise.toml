[tools]
kind = "latest"
helm = "latest"
cilium-cli = "latest"
cilium-hubble = "latest"
kyverno = "latest"

[env]
CILIUM_VERSION = "1.19.1"
HUBBLE_UI_VERSION = "0.13.3"
CILIUM_ENVOY_VERSION = "1.35.9-1770979049-232ed4a26881e4ab4f766f251f258ed424fff663"
KYVERNO_CHART_VERSION = "3.7.0"
KYVERNO_APP_VERSION = "1.17.0"
KIND_CLUSTER_NAME = "k8s-defense-lab"

[tasks."kind:start"]
description = "Create the k8s-defense-lab kind cluster using kind/kind.config"
run = "kind create cluster --config kind/kind.config"

[tasks."kind:delete"]
description = "Delete the k8s-defense-lab kind cluster"
run = "kind delete cluster --name $KIND_CLUSTER_NAME"

[tasks."helm:repo:add"]
description = "Add the Cilium and Kyverno Helm repos"
run = [
  "helm repo add cilium https://helm.cilium.io/",
  "helm repo add kyverno https://kyverno.github.io/kyverno/",
  "helm repo update"
]

[tasks."cilium:pull"]
description = "Pull Cilium images from the registry to the local Docker daemon"
run = [
  "docker pull quay.io/cilium/cilium:v$CILIUM_VERSION",
  "docker pull quay.io/cilium/operator-generic:v$CILIUM_VERSION",
  "docker pull quay.io/cilium/hubble-relay:v$CILIUM_VERSION",
  "docker pull quay.io/cilium/hubble-ui:v$HUBBLE_UI_VERSION",
  "docker pull quay.io/cilium/hubble-ui-backend:v$HUBBLE_UI_VERSION",
  "docker pull quay.io/cilium/cilium-envoy:$CILIUM_ENVOY_VERSION",
]

[tasks."cilium:load"]
description = "Load Cilium images from the local Docker daemon into the kind cluster nodes"
depends = ["cilium:pull"]
run = [
  "kind load docker-image quay.io/cilium/cilium:v$CILIUM_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image quay.io/cilium/operator-generic:v$CILIUM_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image quay.io/cilium/hubble-relay:v$CILIUM_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image quay.io/cilium/hubble-ui:v$HUBBLE_UI_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image quay.io/cilium/hubble-ui-backend:v$HUBBLE_UI_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image quay.io/cilium/cilium-envoy:$CILIUM_ENVOY_VERSION --name $KIND_CLUSTER_NAME",
]

[tasks."kyverno:pull"]
description = "Pull Kyverno images from the registry to the local Docker daemon"
run = [
  "docker pull ghcr.io/kyverno/kyverno:v$KYVERNO_APP_VERSION",
  "docker pull ghcr.io/kyverno/background-controller:v$KYVERNO_APP_VERSION",
  "docker pull ghcr.io/kyverno/cleanup-controller:v$KYVERNO_APP_VERSION",
  "docker pull ghcr.io/kyverno/reports-controller:v$KYVERNO_APP_VERSION",
]

[tasks."kyverno:load"]
description = "Load Kyverno images from the local Docker daemon into the kind cluster nodes"
depends = ["kyverno:pull"]
run = [
  "kind load docker-image ghcr.io/kyverno/kyverno:v$KYVERNO_APP_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image ghcr.io/kyverno/background-controller:v$KYVERNO_APP_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image ghcr.io/kyverno/cleanup-controller:v$KYVERNO_APP_VERSION --name $KIND_CLUSTER_NAME",
  "kind load docker-image ghcr.io/kyverno/reports-controller:v$KYVERNO_APP_VERSION --name $KIND_CLUSTER_NAME",
]

[tasks."cilium:uninstall"]
description = "Uninstall Cilium from the cluster using Helm"
run = "helm uninstall cilium --namespace kube-system"

[tasks."kyverno:uninstall"]
description = "Uninstall Kyverno from the cluster using Helm"
run = "helm uninstall kyverno --namespace kyverno"

[tasks."cilium:install"]
description = "Install Cilium in kube-proxy-free mode using Helm"
depends = ["helm:repo:add", "cilium:load"]
run = """
APISERVER_IP=$(kubectl get endpoints kubernetes -ojsonpath='{.subsets[0].addresses[0].ip}')
helm install cilium cilium/cilium \
  --namespace kube-system \
  --version $CILIUM_VERSION \
  --values cilium/values.yaml \
  --set k8sServiceHost=$APISERVER_IP \
  --set k8sServicePort=6443
"""
run_windows = """
$APISERVER_IP = kubectl get endpoints kubernetes -ojsonpath='{.subsets[0].addresses[0].ip}'
helm install cilium cilium/cilium `
  --namespace kube-system `
  --version $env:CILIUM_VERSION `
  --values cilium/values.yaml `
  --set k8sServiceHost=$APISERVER_IP `
  --set k8sServicePort=6443
"""

[tasks."cluster:up"]
description = "Bootstrap the full cluster: kind + Cilium + Kyverno in order"
depends = ["kind:start"]
run = "mise run cilium:install && cilium status --wait && mise run kyverno:install"
run_windows = "mise run cilium:install && cilium status --wait && mise run kyverno:install"

[tasks."kyverno:install"]
description = "Install Kyverno using Helm"
depends = ["helm:repo:add", "kyverno:load"]
run = """
helm install kyverno kyverno/kyverno \
  --namespace kyverno \
  --create-namespace \
  --version $KYVERNO_CHART_VERSION \
  --values kyverno/values.yaml
"""
run_windows = """
helm install kyverno kyverno/kyverno `
  --namespace kyverno `
  --create-namespace `
  --version $env:KYVERNO_CHART_VERSION `
  --values kyverno/values.yaml
"""
